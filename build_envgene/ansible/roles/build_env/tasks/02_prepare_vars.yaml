---
- name: decrypt {{ cred_config_path }} with instance secret-key
  crypt:
    crypt_type: "decrypt"
    source_file: "{{ cred_config_path }}"
  register: decrypt_creds
  no_log: false

- name: Set env_definition path
  set_fact:
    env_definition_path: "{{ envs_directory_path + '/' + cluster_name + '/' + environment_name + '/Inventory/env_definition.yml' }}"

- name: Include vars from environments file
  set_fact:
    env_definition:   "{{ lookup('file', env_definition_path) | from_yaml }}"

- name: Include vars from credentials file
  set_fact:
    cred_config: "{{ decrypt_creds.result | from_yaml }}"
  no_log: false

- name: Check if custom logic for preparing vars exists
  stat:
    path: "{{ prepare_vars_extension_path }}"
  register: custom_logic_script

- name: Include custom logic
  script: "{{ prepare_vars_extension_path }}"
  when: custom_logic_script.stat.exists

- name: include old logic
  include_tasks: 02_prepare_vars_old.yaml
  when: 
    - skip_original_logic is undefined or not skip_original_logic 
    - env_definition['envTemplate']['artifact'] is undefined

- name: include new logic
  include_tasks: 02_prepare_vars_new.yaml
  when:
    - skip_original_logic is undefined or not skip_original_logic 
    - env_definition['envTemplate']['artifact'] is defined
