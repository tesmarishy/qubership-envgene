# Template Macros

- [Template Macros](#template-macros)
  - [Jinja macros](#jinja-macros)
    - [`templates_dir`](#templates_dir)
    - [`current_env.name`](#current_envname)
    - [`current_env.tenant`](#current_envtenant)
    - [`current_env.cloud`](#current_envcloud)
    - [`current_env.cloudNameWithCluster`](#current_envcloudnamewithcluster)
    - [`current_env.cmdb_name`](#current_envcmdb_name)
    - [`current_env.cmdb_url`](#current_envcmdb_url)
    - [`current_env.description`](#current_envdescription)
    - [`current_env.owners`](#current_envowners)
    - [`current_env.env_template`](#current_envenv_template)
    - [`current_env.additionalTemplateVariables`](#current_envadditionaltemplatevariables)
    - [`current_env.cloud_passport`](#current_envcloud_passport)
    - [`current_env.solution_structure`](#current_envsolution_structure)
  - [Envgene macros](#envgene-macros)
    - [Credential macros](#credential-macros)

This documentation provides a list of macros that can be used during template generation

## Jinja macros

These Jinja macros that can be used during template generation

### `templates_dir`

---
**Description:** Absolute path to templates directory. Autogenerated. Usually used to include templates.  

**Type:** string  

**Basic usage:**

```yaml
tenant: "{{ templates_dir }}/env_templates/composite-dev/tenant.yml.j2"  
```

**Usage in sample:** [Sample](samples/templates/env_templates/simple.yaml)  

### `current_env.name`

---
**Description:** Name of environment. Value is set from `env_definition.inventory.environmentName`.  

**Type:** string  

**Basic usage:**

```yaml
name: "{{current_env.name }}-oss" 
```

**Usage in sample:** [Sample](samples/templates/env_templates/composite-dev/Namespaces/oss.yml.j2)  

### `current_env.tenant`

---
**Description:** Name of Tenant for environment. Value is set from `env_definition.inventory.tenantName`.  

**Type:** string  

**Basic usage:**

```yaml
name: "{{ current_env.tenant }}"
```

**Usage in sample:** [Sample](samples/templates/env_templates/composite-dev/tenant.yml.j2)  

### `current_env.cloud`

---
**Description:** Name of Cloud for environment. If parameter `inventory.cloudName` is set in env_definition, than value will be set from `env_definition.inventory.cloudName`. If not, value will be equal to environment name with `(env_definition.inventory.environmentName).replace("-","_")`.  

**Type:** string  

**Basic usage:**

```yaml
name: "{{ current_env.cloud }}"
```

**Usage in sample:** [Sample](samples/templates/env_templates/simple/cloud.yml.j2)  

### `current_env.cloudNameWithCluster`

---
**Description:** Name of Cloud for environment. Value will include cluster name and environment name. Value is generated with the following rules:

If parameter `inventory.cloudName` is set in env_definition:  
  than value will be set from `env_definition.inventory.cloudName`.

Else if parameter `inventory.cloudPassport` is set in env_definition:  
  than value will be set to `(<env_definition.inventory.cloudPassport>+'_'+<env_definition.inventory.environmentName>).replace("-","_")`.

Else:  
  value will be set to `(<name of folder with cluster>+'_'+<env_definition.inventory.environmentName>).replace("-","_")`.  

**Type:** string  

**Basic usage:**

```yaml
name: "{{ current_env.cloudNameWithCluster }}"
```

**Usage in sample:** [Sample](samples/templates/env_templates/composite-dev/cloud.yml.j2)  

### `current_env.cmdb_name`

---
**Description:** Name of CMDB/deployer used for environment. Value is set from `env_definition.inventory.deployer`.  

**Type:** string  

**Basic usage:**

```yaml
```

**Usage in sample:**  

### `current_env.cmdb_url`

---
**Description:** Url of CMDB used for environment. Value is automatically calculated using the link from `env_definition.inventory.deployer`.  

**Type:** string  

**Basic usage:**

```yaml
```

**Usage in sample:**  

### `current_env.description`

---
**Description:** Description of environment. Value is set from `env_definition.inventory.description`. Default "".  

**Type:** string  

**Basic usage:** `description: "{{ current_env.description }}"`  

```yaml
```

**Usage in sample:** [Sample](samples/templates/env_templates/composite-dev/cloud.yml.j2)  

### `current_env.owners`

---
**Description:** Owners of environment. Value is set from `env_definition.inventory.owners`. Default "".  

**Type:** string  

**Basic usage:** `owners: "{{ current_env.owners }}"`

```yaml
```

**Usage in sample:** [Sample](samples/templates/env_templates/composite-dev/cloud.yml.j2)  

### `current_env.env_template`

---
**Description:** Name of the template used for generation. Value is set from `env_definition.envTemplate.name`. Default "".  

**Type:** string  

**Basic usage:** `TEMPLATE_NAME: "{{ current_env.env_template }}"`

```yaml
```

**Usage in sample:**  

### `current_env.additionalTemplateVariables`

---
**Description:** Hashable to pass additional parameters for template rendering. Values should be specified in `envTemplate.additionalTemplateVariables` section of `env_definition.yaml` in your inventory. Default {}.  

**Type:** HashMap  

**Basic usage:**

```yaml
deployParameters:
  INSTANCES_LEVEL_VAR_GLOBAL: "{{ current_env.additionalTemplateVariables.GLOBAL_LEVEL_PARAM1 }}"
  INSTANCES_LEVEL_VAR_CLOUD: "{{ current_env.additionalTemplateVariables.CLOUD_LEVEL_PARAM1 }}"
```

**Usage in sample:** [Sample](samples/templates/env_templates/composite-prod/cloud.yml.j2)

### `current_env.cloud_passport`

---
**Description:** Hashable with values from cloud passport files defined in `env_definition.yaml` in your inventory. Default {}

**Type:** HashMap  

**Basic usage:**

```yaml
{% if current_env.cloud_passport.cloud.CLOUD_PUBLIC_HOST is defined %}
  e2eParameters:
    CLOUD_PUBLIC_HOST_E2E: "{{ current_env.cloud_passport.cloud.CLOUD_PUBLIC_HOST}}"
{% else %}
  e2eParameters: {}
{% endif %}
```

**Usage in sample:** [Sample](test_data/test_templates/env_templates/composite-dev/cloud.yml.j2)

### `current_env.solution_structure`

---
**Description:** A hashable with values describing the structure of the solution - its composition by applications and the mapping of these applications to namespaces. The variable has the following structure:

```yaml
<application-name-A>:
  <deploy-postfix-A>:
    version: <application-version-A>
    namespace: <namespace-A>
<application-name-B>:
  <deploy-postfix-B>:
    version: <application-version-B>
    namespace: <namespace-B>
  <deploy-postfix-C>:
    version: <application-version-C>
    namespace: <namespace-C>
```

The variable is obtained by transforming the file defined in the path `/configuration/environments/<CLUSTER-NAME>/<ENV-NAME>/solution-descriptor/sd.yml`.

The value of the `namespace` attribute in this variable is obtained from the `name` attribute of the **already rendered** `Namespace` object. The definition of the object is located at `/configuration/environments/<CLUSTER-NAME>/<ENV-NAME>/Namespaces/<deployPostfix>/namespace.yml`. If the corresponding `Namespace` object is not found, the `namespace` value is set to `Null`.

Default value is `{}`

**Type:** HashMap  

**Basic usage:**

```yaml
  deployParameters:
{% if 'billing-app' in current_env.solution_structure %}
    param: value-1
{% else %}
    param: value-2
{% endif %}
```

```yaml
  deployParameters:
    oss_ns: "{{ current_env.solution_structure['oss-app]['oss'].namespace }}"
```

**Usage in sample:**

- [Sample template](/samples/templates/env_templates/composite-dev/Namespaces/bss.yml.j2)
- [Sample inventory](/samples/environments/sample-cloud-name/composite-with-creds/)

## Envgene macros

### Credential macros

---
**Description:** This macro marks parameters as sensitive, triggering special processing that differs from regular parameters.

```text
${envgen.creds.get('<cred-id>').username|password|secret}
```

For each `<cred-id>` during Environment Instance generation a [Credential](/docs/envgene-objects.md#credential) object is created in the [Environment Credential File](/docs/envgene-objects.md#environment-credential-file)

Type assignment:

- `usernamePassword` for `username` and `password` attributes
- `secret` for `secret` attribute

**Basic usage:**

```yaml
kafka_username: ${envgen.creds.get('kafka-cred').username}
kafka_password: ${envgen.creds.get('kafka-cred').password}
k8s_token: ${envgen.creds.get('k8s-cred').secret}
```

**Usage in sample:** [Sample](/samples/templates/parameters/composite-sample/test-deploy-creds.yml)
